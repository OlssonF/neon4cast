
<!-- README.md is generated from README.Rmd. Please edit that file -->

# neon4cast

<!-- badges: start -->

[![R-CMD-check](https://github.com/eco4cast/neon4cast/workflows/R-CMD-check/badge.svg)](https://github.com/eco4cast/neon4cast/actions)
<!-- badges: end -->

`neon4cast` provides a collection of convenient helper utilities for
anyone entering the EFI NEON Forecasting Challenge.

## Installation

You can install the development version from
[GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("eco4cast/neon4cast")
```

## Examples

``` r
library(neon4cast)
```

For these examples, we will use a forecast generated by the Aquatics
Null Model starting 2020-02-01 to show how functions work. We download
this from the EFI server. In general, you would replace this
`forecast_file` with the forecast file you are developing for the
challenge.

``` r
example_url <- "https://data.ecoforecast.org/forecasts/aquatics/aquatics-2021-02-01-EFInull.csv.gz"
forecast_file <- "aquatics-2021-02-01-EFInull.csv.gz"
download.file(example_url, forecast_file)
```

### Validate a forecast file

Validating a forecast file runs the same automated checks as the EFI
server, verifying that the data is in the correct format for the
appropriate challenge. Helpful errors or warnings will displayed on any
invalid formats. Note that the validator accepts files in `.csv`
(optionally compressed as `.csv.gz`) or netcdf.

``` r
forecast_output_validator("aquatics-2021-02-01-EFInull.csv.gz")
#> aquatics-2021-02-01-EFInull.csv.gz
#> ✓ file name is correct
#> 
#> ── Column specification ────────────────────────────────────────────────────────
#> cols(
#>   time = col_date(format = ""),
#>   ensemble = col_double(),
#>   siteID = col_character(),
#>   oxygen = col_double(),
#>   temperature = col_double(),
#>   obs_flag = col_double(),
#>   forecast = col_double(),
#>   data_assimilation = col_double()
#> )
#> ✓ target variables found
#> ✓ file has ensemble members
#> ✓ file has siteID column
#> ✓ file has time column
#> ✓ file has correct time column
#> [1] TRUE
```

### Compute forecast scores locally

Scores for valid forecasts should appear at
<https://shiny.ecoforecast.org> the day after they are submitted.
However, it is often more convenient to generate scores locally. Note
that the “score” simply the `crps_sample` (for ensemble forecasts) or
`crps_norm` (for summary statistic forecasts) score from the
`scoringRules` R package, for each unique prediction
(i.e. day/site/variable tuple).

Note that scores are only possible once the data becomes available in
the corresponding targets file\! Consider forecasting an earlier period
or merely wait for future data to become available. Latencies for
individual challenges are listed in each challenge specification.

``` r
forecast <- readr::read_csv("aquatics-2021-02-01-EFInull.csv.gz")
#> 
#> ── Column specification ────────────────────────────────────────────────────────
#> cols(
#>   time = col_date(format = ""),
#>   ensemble = col_double(),
#>   siteID = col_character(),
#>   oxygen = col_double(),
#>   temperature = col_double(),
#>   obs_flag = col_double(),
#>   forecast = col_double(),
#>   data_assimilation = col_double()
#> )
score(forecast, theme = "aquatics")
#> 
#> ── Column specification ────────────────────────────────────────────────────────
#> cols(
#>   time = col_date(format = ""),
#>   siteID = col_character(),
#>   oxygen = col_double(),
#>   temperature = col_double(),
#>   oxygen_sd = col_double(),
#>   temperature_sd = col_double(),
#>   depth_oxygen = col_double(),
#>   depth_temperature = col_double(),
#>   neon_product_ids = col_character()
#> )
#> # A tibble: 28 x 4
#>    siteID time       target        score
#>    <chr>  <date>     <chr>         <dbl>
#>  1 BARC   2021-02-01 oxygen       0.0843
#>  2 BARC   2021-02-01 temperature NA     
#>  3 BARC   2021-02-02 oxygen       0.103 
#>  4 BARC   2021-02-02 temperature NA     
#>  5 BARC   2021-02-03 oxygen       0.209 
#>  6 BARC   2021-02-03 temperature NA     
#>  7 BARC   2021-02-04 oxygen       0.224 
#>  8 BARC   2021-02-04 temperature NA     
#>  9 BARC   2021-02-05 oxygen       0.211 
#> 10 BARC   2021-02-05 temperature NA     
#> # … with 18 more rows
```

### Generate forecast metadata in EML

Coming soon\!

### Access EFI snapshots of NOAA forecasts at NEON sites

Many forecasts will want to make use of weather forecasts as potential
drivers. EFI downscales NOAA GEFS 35-day forecast products at each NEON
site and makes this data available. These helper functions provide
convenient access for downloading and stacking the individual forecast
files.

``` r
download_noaa("ABBY")
abby <- stack_noaa()
abby
#> # A tibble: 4,295 x 13
#>    file  air_temperature air_pressure relative_humidity surface_downwelling_lon…
#>    <chr>           <dbl>        <dbl>             <dbl>                    <dbl>
#>  1 1                286.       97149.             0.495                      NaN
#>  2 1                279.       96964.             0.786                      268
#>  3 1                277.       96738.             0.955                      279
#>  4 1                283.       96376.             0.643                      302
#>  5 1                279.       96320.             0.981                      335
#>  6 1                272.       96824.             0.947                      309
#>  7 1                270.       96937.             0.916                      222
#>  8 1                276.       97024.             0.771                      259
#>  9 1                278.       96950.             0.713                      286
#> 10 1                271.       97160.             0.936                      236
#> # … with 4,285 more rows, and 8 more variables:
#> #   surface_downwelling_shortwave_flux_in_air <dbl>, precipitation_flux <dbl>,
#> #   specific_humidity <dbl>, cloud_area_fraction <dbl>, wind_speed <dbl>,
#> #   time <dbl>, latitude <dbl>, longitude <dbl>
```

### Submit a forecast

When you are ready to submit,

``` r
submit("aquatics-2021-02-01-EFInull.csv.gz")
```

### Other functions

Encountered a bug? Facing another challenge in participating in the
challenge? Developed a cool approach you would like to share with the
community? Open an [issue](https://github.com/eco4cast/neon4cast/issues)
or [pull request](https://github.com/eco4cast/neon4cast/pulls) here\!
